<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    div{
      line-height: 25px;
    }
    #canvas {
      margin: 0 auto;
      display: block;
      cursor: default;
    }
    #color-block1,#color-block2,#color-block3,#color-block4{
      width: 20px;
      height: 20px;
      display: inline-block;
      margin: 0 5px;
      background: transparent;
      border: 1px solid #ccc;
    }
    .flex{
      display: flex;
      align-items: center;
      text-align: center;
      line-height: 30px;
      cursor: pointer;
      color: #888;
      transition: color 0.3s;
    }
    .flex:hover{
      color: #000;
    }
    .root{
      position: absolute;
    }
  </style>
</head>
<body>
  <iframe
      style="margin-left: 2px; margin-bottom:-5px;"
      frameborder="0" scrolling="0" width="100px" height="20px"
      src="https://ghbtns.com/github-btn.html?user=AwesomeDevin&repo=ColorUtils&type=star&count=true" >
  </iframe>
  <!-- <iframe
      style="margin-left: 2px; margin-bottom:-5px;"
      frameborder="0" scrolling="0" width="100px" height="20px"
      src="https://ghbtns.com/github-btn.html?user=AwesomeDevin&repo=ColorUtils&type=fork&count=true" >
  </iframe> -->
  <div class="root">
    <h3>图片操作选项</h3>
    <label class="flex">
      提取色值1： 
      <input type='radio' value='pickColor1' name='action' checked onchange="changeAction(this.value)"  /> 
      <div id="color-block1"></div>
    </label>
    <label class="flex">
      提取色值2： 
      <input type='radio' value='pickColor2' name='action' onchange="changeAction(this.value)"  /> 
      <div id="color-block2"></div>
    </label>
    <label class="flex">
      边界自动吸附（找不到临界点则不移动）：
      <input type='radio' value='adjust' name='action' onchange="changeAction(this.value)" />
    </label>

    <div class="flex">
      色值1/色值2 相识度对比：
      <div id="color-block3"></div>
      <div id="color-block4"></div>
      <button id='compareBtn'>开始对比</button>
    </div>
    
    <div class="flex">
      更换图片：
      <input type="file" id="upload" accept="image/png,image/jpeg,image/jpg" />
    </div>

    <h3>参数配置</h3>
    <div class="flex">
      色彩边界阈值（阈值越高，相似条件越低）：
      <input type='range' id='boundary' name='boundaryValue' value="10"  min="5" max="100" step="5"/>
      <span id="boundaryText">10</span>
    </div>
    <div class="flex">
      边界扫描距离（由内向外）：
      <input type='range' id='mockMove' name='mockMovePx' value="30"  min="10" max="200" step="10"/>
      <span id="mockMoveText">30</span>
    </div>
    
  </div>
  <canvas id='canvas' width="375" height="812"> </canvas>
  <!-- <script type="module" src="./build/bundle.js">
  </script> -->
  <script>
    var action = 'pickColor1'
    var blockColor1 = [255,255,255]
    var blockColor2 = [255,255,255]


    const canvasDom = document.getElementById('canvas')


    function changeAction(value){
      action = value
      canvasDom.style.cursor = action === 'adjust' ?  'crosshair' : `default`
    }

  </script>
  <script type="module">
    import { ImageColorUtils } from './build/index.es.js'


    var main = {
      // 初始化
      init(){
        const imageUrl = 'https://storage.360buyimg.com/dataset-activity-mini/png-jpg-00002-2.jpg'
        const width = 500
        this.isDrawing = false
        this.rects = []
        this.boundaryValue = 10
        this.mockMovePx = 30

        this.colorBlock1 = document.getElementById('color-block1')
        this.colorBlock2 = document.getElementById('color-block2')
        this.colorBlock3 = document.getElementById('color-block3')
        this.colorBlock4 = document.getElementById('color-block4')

        this.boundary = document.getElementById('boundary')
        this.boundaryText = document.getElementById('boundaryText')

        this.mockMove = document.getElementById('mockMove')
        this.mockMoveText = document.getElementById('mockMoveText')


        this.compareBtn = document.getElementById('compareBtn')
        this.upload = document.getElementById('upload')
        this.canvas = document.getElementById('canvas')
        this.ctx = canvas.getContext('2d')
        
        this.img = new Image()
        this.img.crossOrigin = 'Anonymous'
        this.img.onload = () => {
          
          const height = width/this.img.width * this.img.height
          // 计算出画布的宽高
          this.initCanvas(width, height)
          this.initEvent()
        }
        this.img.src = imageUrl

        
      },

      initCanvas(width,height) {
        const lineColor = '#12f430'
        this.canvas.width = width
        this.canvas.height = height
        this.ctx.lineWidth = 3
        this.ctx.strokeStyle = lineColor 
        this.clear()
        this.drawImage()
        this.imageData = this.ctx.getImageData(0,0,this.canvas.width, this.canvas.height)
      },

      // 绘制
      draw(x, y, width, height) {
        this.clear()
        this.drawImage()
        this.drawRect(x, y, width, height)
        this.rects.forEach(rect => {
          this.drawRect(rect.x, rect.y, rect.width, rect.height)
        })
      },

      // 清除画布
      clear() {
        this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height)
      },

      // 绘制图片
      drawImage() {
        this.ctx.drawImage(this.img,0,0,this.canvas.width, this.canvas.height)
      },

      // 绘制标注框
      drawRect(x, y, width, height){
        this.ctx.strokeRect(x,y,width,height)
      },

      // 事件监听初始化
      initEvent(){
        let startX
        let startY
        let endX
        let endY
        const self = this

        function adjust(leftTopPosition, rightBottomPosition) {
          const adjust = new ImageColorUtils({ leftTopPosition, rightBottomPosition, boundaryValue: self.boundaryValue, mockMovePx: self.mockMovePx })
          return adjust.adjust(self.imageData, Math.floor(self.canvas.width))
        }

        function end() {
          self.rects.push(adjust([startX, startY], [endX, endY] ))
          
          startX = startY = endX = endY = null
          self.isDrawing = false
          self.draw()
        }

        this.boundary.addEventListener('change',(e)=>{
          const value = parseInt(e.target.value)
          this.boundaryValue = value
          this.boundaryText.innerHTML = value
        })

        this.mockMove.addEventListener('change',(e)=>{
          const value = parseInt(e.target.value)
          this.mockMovePx = value
          this.mockMoveText.innerHTML = value
        })

        this.upload.addEventListener('change',(e)=>{
          const reader  = new FileReader();
          reader.addEventListener('load', () => {
            this.img.src = reader.result;
            this.rects = []
          }, false);
          reader.readAsDataURL(e.target.files[0]);
        })
        
        this.compareBtn.addEventListener('click', () => {
          const colorUtils = new ImageColorUtils({boundaryValue: this.boundaryValue, mockMovePx: this.mockMovePx})
          const result = colorUtils.compare(blockColor1, blockColor2)
          this.compareBtn.innerHTML = `（结果：${result ? '相似': '不相似'}）点击继续对比`
        })

        this.canvas.addEventListener('click', (e) => {
          if(!action.match('pickColor') && action !== 'compare' ){
            return
          }
          const x = e.offsetX
          const y = e.offsetY

          const pickColor = new ImageColorUtils().pickColor(this.imageData, x, y, this.canvas.width)
          const color = `rgb(${pickColor[0]},${pickColor[1]},${pickColor[2]})`

          if(action === 'pickColor1'){
            this.colorBlock1.style.backgroundColor = color
            this.colorBlock3.style.backgroundColor = color

            blockColor1 = pickColor
          } else if(action === 'pickColor2'){
            this.colorBlock2.style.backgroundColor = color
            this.colorBlock4.style.backgroundColor = color

            blockColor2 = pickColor
          }
          

        })

        this.canvas.addEventListener('mousedown', (e) => {
          if(action !== 'adjust'){
            return
          }
          this.isDrawing = true
          startX = e.offsetX 
          startY = e.offsetY

          this.canvas.addEventListener('mousemove', (e) => {
            if(!this.isDrawing){
              return
            }
            endX = e.offsetX 
            endY= e.offsetY
            
            this.draw(startX, startY, endX - startX, endY - startY )
          })

          this.canvas.addEventListener('mouseup', (e) => {
            if(!this.isDrawing){
              return
            }
            end()
          })

          this.canvas.addEventListener('mouseout', () => {
            if(!this.isDrawing){
              return
            }
            end()
          })

        })
        
      }
    }


    main.init()


    
  </script>
</body>
</html>